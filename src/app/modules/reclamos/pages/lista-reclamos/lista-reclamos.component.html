<div class="container-fluid mt-4 mb-5">
    <div class="d-flex justify-content-between align-items-center mb-4">
        <h1>Gestión de Reclamos</h1>
        <ng-container *appRoleBased="['AtencionCliente']">
            <button class="btn btn-primary" routerLink="/reclamos/nuevo">
                <i class="fas fa-plus me-1"></i> Nuevo Reclamo
            </button>
        </ng-container>
    </div>

    <!-- Tarjeta de filtros -->
    <div class="card mb-4 shadow-sm">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Filtros</h5>
                <button class="btn btn-sm btn-link" (click)="toggleFiltros()">
                    <i class="fas" [ngClass]="mostrarFiltros ? 'fa-chevron-up' : 'fa-chevron-down'"></i>
                </button>
            </div>
        </div>
        <div class="card-body" [ngClass]="{'d-none': !mostrarFiltros}">
            <form [formGroup]="filtrosForm" (ngSubmit)="aplicarFiltros()">
                <div class="row g-3">
                    <!-- Filtro por Ticket ID -->
                    <div class="col-md-3 col-sm-6">
                        <label class="form-label">Ticket ID</label>
                        <input type="text" class="form-control" placeholder="Ej. TC-00000009"
                            formControlName="ticketId">
                    </div>

                    <!-- Filtro por Rango de Fechas -->
                    <div class="col-md-4 col-sm-6">
                        <div class="row">
                            <div class="col-md-6">
                                <label class="form-label">Fecha Desde</label>
                                <input type="date" class="form-control" formControlName="fechaDesde">
                            </div>
                            <div class="col-md-6">
                                <label class="form-label">Fecha Hasta</label>
                                <input type="date" class="form-control" formControlName="fechaHasta">
                            </div>
                        </div>
                    </div>

                    <!-- Filtro por Estado -->
                    <div class="col-md-2 col-sm-6">
                        <label class="form-label">Estado</label>
                        <select class="form-select" formControlName="estado">
                            <option *ngFor="let option of estadoOptions" [value]="option.value">
                                {{option.label}}
                            </option>
                        </select>
                    </div>

                    <!-- Filtro por Prioridad -->
                    <div class="col-md-2 col-sm-6">
                        <label class="form-label">Prioridad</label>
                        <select class="form-select" formControlName="prioridad">
                            <option *ngFor="let option of prioridadOptions" [value]="option.value">
                                {{option.label}}
                            </option>
                        </select>
                    </div>
                </div>

                <div class="d-flex justify-content-end mt-3 gap-2">
                    <button type="button" class="btn btn-outline-secondary" (click)="limpiarFiltros()">
                        <i class="fas fa-eraser me-1"></i> Limpiar Filtros
                    </button>
                    <button type="submit" class="btn btn-primary">
                        <i class="fas fa-search me-1"></i> Aplicar Filtros
                    </button>
                </div>
            </form>
        </div>
    </div>

    <!-- Tabla de Reclamos -->
    <div class="card shadow-sm">
        <div class="card-header bg-light">
            <div class="d-flex justify-content-between align-items-center">
                <h5 class="mb-0">Listado de Reclamos</h5>
                <span class="badge bg-primary">{{totalReclamos}} reclamos encontrados</span>
            </div>
        </div>
        <div class="card-body p-0">
            <div class="table-responsive">
                <table class="table table-hover table-striped mb-0">
                    <thead class="table-light">
                        <tr>
                            <th scope="col">Ticket ID</th>
                            <th scope="col">Cliente</th>
                            <th scope="col">Fecha Creación</th>
                            <th scope="col">Estado</th>
                            <th scope="col">Prioridad</th>
                            <th scope="col">Motivo</th>
                            <th scope="col">Días Abierto</th>
                            <!-- Columna de Asignados solo visible para AtencionCliente o Administrador -->
                            <th scope="col" *appRoleBased="['AtencionCliente', 'Administrador']">Asignado a</th>
                            <th scope="col" class="text-center">Acciones</th>
                        </tr>
                    </thead>
                    <tbody>
                        <tr *ngFor="let reclamo of reclamosFiltrados">
                            <td>
                                <span class="ticket-code">{{ reclamo.ticketId }}</span>
                            </td>
                            <td>{{ reclamo.nombreCompleto }}</td>
                            <td>{{ reclamo.fechaCreacion | date:'dd/MM/yyyy HH:mm' }}</td>
                            <td>
                                <span class="badge estado-badge" [ngClass]="getEstadoClass(reclamo.estado)">
                                    <i [class]="getEstadoIcon(reclamo.estado)"></i> {{ formatearEstado(reclamo.estado)
                                    }}
                                </span>
                            </td>
                            <td>
                                <span class="badge" [ngClass]="getPrioridadClass(reclamo.prioridad)">
                                    <i class="fas fa-flag me-1"></i> {{ reclamo.prioridad }}
                                </span>
                            </td>
                            <td>{{ reclamo.motivoNombre }}</td>
                            <td class="text-center">
                                <span class="badge" [ngClass]="getDiasAbiertoBadgeClass(reclamo.diasAbierto)">
                                    {{ reclamo.diasAbierto }}
                                </span>
                            </td>
                            <!-- Columna de Asignados solo visible para AtencionCliente o Administrador -->
                            <td *appRoleBased="['AtencionCliente', 'Administrador']">
                                <div *ngFor="let asignacion of reclamo.asignaciones" class="assignee-item">
                                    <small>
                                        <i class="fas fa-user-tie me-1"></i>
                                        {{asignacion.nombreCompleto}}
                                        <span class="text-muted">({{formatearRol(asignacion.rolNombre)}})</span>
                                    </small>
                                </div>
                                <div *ngIf="reclamo.asignaciones.length === 0" class="text-muted">
                                    <small><i class="fas fa-exclamation-circle me-1"></i>Sin asignar</small>
                                </div>
                            </td>
                            <td class="text-center">
                                <button class="btn btn-sm btn-primary" title="Ver detalle"
                                    (click)="verDetalle(reclamo.ticketId)">
                                    <i class="fas fa-eye me-1"></i> Ver
                                </button>
                            </td>
                        </tr>
                        <tr *ngIf="reclamosFiltrados.length === 0 && !cargando">
                            <td [attr.colspan]="getColumnCount()" class="text-center py-4">
                                <div class="empty-state">
                                    <i class="fas fa-search fa-3x text-muted mb-3"></i>
                                    <p class="mb-0 text-muted">No se encontraron reclamos que coincidan con los
                                        criterios de búsqueda</p>
                                    <button class="btn btn-sm btn-outline-primary mt-3" (click)="limpiarFiltros()">
                                        <i class="fas fa-redo me-1"></i> Limpiar filtros y volver a intentar
                                    </button>
                                </div>
                            </td>
                        </tr>
                        <tr *ngIf="cargando">
                            <td [attr.colspan]="getColumnCount()" class="text-center py-4">
                                <div class="spinner-border text-primary" role="status">
                                    <span class="visually-hidden">Cargando...</span>
                                </div>
                                <p class="mb-0 mt-2">Cargando reclamos...</p>
                            </td>
                        </tr>
                    </tbody>
                </table>
            </div>
        </div>

        <div class="card-footer d-flex justify-content-between align-items-center flex-wrap">
            <div class="showing-info mb-2 mb-md-0">
                Mostrando {{ (paginaActual - 1) * itemsPorPagina + 1 }} a
                {{ (paginaActual * itemsPorPagina) > totalReclamos ? totalReclamos : (paginaActual * itemsPorPagina) }}
                de {{ totalReclamos }} reclamos
            </div>

            <!-- Paginación -->
            <nav aria-label="Paginación" class="mb-2 mb-md-0">
                <ul class="pagination mb-0">
                    <li class="page-item" [class.disabled]="paginaActual === 1">
                        <a class="page-link" href="javascript:void(0)" (click)="cambiarPagina(1)">
                            <i class="fas fa-angle-double-left"></i>
                        </a>
                    </li>
                    <li class="page-item" [class.disabled]="paginaActual === 1">
                        <a class="page-link" href="javascript:void(0)" (click)="cambiarPagina(paginaActual - 1)">
                            <i class="fas fa-angle-left"></i>
                        </a>
                    </li>

                    <li class="page-item" *ngFor="let pagina of getPaginas()" [class.active]="paginaActual === pagina">
                        <a class="page-link" href="javascript:void(0)" (click)="cambiarPagina(pagina)">
                            {{ pagina }}
                        </a>
                    </li>

                    <li class="page-item" [class.disabled]="paginaActual === totalPaginas">
                        <a class="page-link" href="javascript:void(0)" (click)="cambiarPagina(paginaActual + 1)">
                            <i class="fas fa-angle-right"></i>
                        </a>
                    </li>
                    <li class="page-item" [class.disabled]="paginaActual === totalPaginas">
                        <a class="page-link" href="javascript:void(0)" (click)="cambiarPagina(totalPaginas)">
                            <i class="fas fa-angle-double-right"></i>
                        </a>
                    </li>
                </ul>
            </nav>

            <!-- Selector de items por página -->
            <div>
                <select class="form-select form-select-sm" [(ngModel)]="itemsPorPagina"
                    (change)="cambiarItemsPorPagina(itemsPorPagina)">
                    <option [ngValue]="10">10 por página</option>
                    <option [ngValue]="25">25 por página</option>
                    <option [ngValue]="50">50 por página</option>
                    <option [ngValue]="100">100 por página</option>
                </select>
            </div>
        </div>
    </div>
</div>