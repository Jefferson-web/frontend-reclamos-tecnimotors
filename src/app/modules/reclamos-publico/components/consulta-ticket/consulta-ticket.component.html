<!-- src/app/modules/reclamos-publico/components/consulta-ticket/consulta-ticket.component.html -->
<div class="container py-5">
  <!-- Header -->
  <div class="text-center mb-5">
    <div class="d-flex align-items-center justify-content-center mb-3">
      <div class="me-3">
        <img src="logo_empresa.jpg" alt="Logo de la empresa" class="header-logo">
      </div>
      <h1 class="ticket-heading m-0">Sistema de Tickets</h1>
    </div>
    <p class="text-muted">Consulta el estado de tu reclamo ingresando el número de ticket</p>
  </div>
  
  <!-- Search Form -->
  <div class="search-box mb-5">
    <form [formGroup]="searchForm" (ngSubmit)="searchTicket()">
      <div class="input-group">
        <input 
          type="text" 
          formControlName="ticketNumber" 
          class="form-control ticket-input" 
          placeholder="Ingresa tu número de ticket" 
          aria-label="Número de ticket"
          [attr.disabled]="loading ? true : null">
        <button 
          class="btn search-btn" 
          type="submit" 
          [disabled]="searchForm.invalid || loading">
          <i class="bi" [ngClass]="loading ? 'bi-hourglass' : 'bi-search'"></i>
        </button>
      </div>
      <div *ngIf="searchForm.get('ticketNumber')?.invalid && searchForm.get('ticketNumber')?.touched" class="text-danger mt-2">
        Por favor ingresa un número de ticket válido
      </div>
    </form>
  </div>
  
  <!-- Loading Indicator -->
  <div class="text-center mb-5" *ngIf="loading">
    <div class="spinner-border text-primary" role="status">
      <span class="visually-hidden">Cargando...</span>
    </div>
    <p class="mt-2">Buscando información del ticket...</p>
  </div>
  
  <!-- Error Message -->
  <div class="text-center mb-5" *ngIf="error">
    <div class="card p-4">
      <div class="text-danger mb-3">
        <i class="bi bi-exclamation-circle" style="font-size: 3rem;"></i>
      </div>
      <h3>Ticket no encontrado</h3>
      <p class="text-muted">{{ errorMessage }}</p>
      <button class="btn btn-outline-primary mt-3" (click)="tryAgain()">
        <i class="bi bi-arrow-counterclockwise me-2"></i>Intentar nuevamente
      </button>
    </div>
  </div>
  
  <!-- Ticket Information -->
  <div *ngIf="showTicketInfo && reclamo">
    <div class="card mb-4">
      <div class="card-body p-4">
        <div class="d-flex justify-content-between align-items-center mb-4">
          <h3 class="card-title m-0">Detalles del Ticket</h3>
          <span class="status-badge" [ngClass]="getStatusClass()">{{ getStatusText() }}</span>
        </div>
        
        <div class="row mb-4">
          <div class="col-md-6 mb-3 mb-md-0">
            <div class="ticket-details">
              <div class="row">
                <div class="col-6">
                  <p class="detail-label">Número de Ticket</p>
                  <p class="detail-value">{{ reclamo.ticketId }}</p>
                </div>
                <div class="col-6">
                  <p class="detail-label">Fecha de Creación</p>
                  <p class="detail-value">{{ reclamo.fechaCreacion | date:'dd/MM/yyyy' }}</p>
                </div>
              </div>
            </div>
          </div>
          <div class="col-md-6">
            <div class="ticket-details">
              <div class="row">
                <div class="col-6">
                  <p class="detail-label">Tipo de Reclamo</p>
                  <p class="detail-value">{{ reclamo.tipoReclamo }}</p>
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Progress Tracker -->
        <div class="progress-container">
          <div class="progress-bar-custom">
            <div class="progress-fill" [style.width]="getProgressPercentage()"></div>
          </div>
          <div class="row">
            <!-- Si el estado es RECHAZADO mostramos un flujo diferente -->
            <ng-container *ngIf="!isRejected(); else rechazadoTemplate">
              <div class="col step" 
                   [ngClass]="{'step-completed': reclamo.estado !== ESTADO.REGISTRADO, 'step-active': reclamo.estado === ESTADO.REGISTRADO}">
                <div class="step-icon">
                  <i class="bi" [ngClass]="reclamo.estado !== ESTADO.REGISTRADO ? 'bi-check-lg' : 'bi-file-earmark-text'"></i>
                </div>
                <div class="step-text">Registrado</div>
              </div>
              <div class="col step" 
                   [ngClass]="{'step-completed': reclamo.estado === ESTADO.ATENDIDO || reclamo.estado === ESTADO.CERRADO, 'step-active': reclamo.estado === ESTADO.EN_PROCESO}">
                <div class="step-icon">
                  <i class="bi" [ngClass]="reclamo.estado === ESTADO.ATENDIDO || reclamo.estado === ESTADO.CERRADO ? 'bi-check-lg' : 'bi-gear'"></i>
                </div>
                <div class="step-text">En Proceso</div>
              </div>
              <div class="col step" 
                   [ngClass]="{'step-completed': reclamo.estado === ESTADO.CERRADO, 'step-active': reclamo.estado === ESTADO.ATENDIDO}">
                <div class="step-icon">
                  <i class="bi" [ngClass]="reclamo.estado === ESTADO.CERRADO ? 'bi-check-lg' : 'bi-headset'"></i>
                </div>
                <div class="step-text">Atendido</div>
              </div>
              <div class="col step" 
                   [ngClass]="{'step-active': reclamo.estado === ESTADO.CERRADO}">
                <div class="step-icon">
                  <i class="bi bi-check-circle"></i>
                </div>
                <div class="step-text">Cerrado</div>
              </div>
            </ng-container>
            
            <ng-template #rechazadoTemplate>
              <div class="col step step-completed">
                <div class="step-icon">
                  <i class="bi bi-check-lg"></i>
                </div>
                <div class="step-text">Registrado</div>
              </div>
              <div class="col step step-completed">
                <div class="step-icon">
                  <i class="bi bi-gear"></i>
                </div>
                <div class="step-text">En Proceso</div>
              </div>
              <div class="col step step-rejected">
                <div class="step-icon">
                  <i class="bi bi-x-lg"></i>
                </div>
                <div class="step-text">Rechazado</div>
              </div>
            </ng-template>
          </div>
        </div>
        
        <!-- Ticket Description -->
        <div class="mt-4">
          <h5>Descripción del Reclamo</h5>
          <p [innerHTML]="reclamo.descripcion"></p>
        </div>
        
        <!-- Acciones Disponibles -->
        <div class="mt-4">
          <h5>Acciones Disponibles</h5>
          <div class="row g-3">
            <div class="col-md-6">
              <button class="btn btn-outline-primary w-100 p-3 d-flex align-items-center justify-content-between" 
                      (click)="showEmailUpdateForm()" *ngIf="!showEmailForm && !emailSent">
                <span><i class="bi bi-envelope me-2"></i>Solicitar actualización por email</span>
                <i class="bi bi-arrow-right"></i>
              </button>
              
              <!-- Formulario de correo -->
              <div class="card p-3" *ngIf="showEmailForm">
                <form [formGroup]="emailForm" (ngSubmit)="requestEmailUpdate()">
                  <h6 class="mb-3">Ingresa tu correo electrónico</h6>
                  <div class="mb-3">
                    <input type="email" class="form-control" formControlName="email" placeholder="ejemplo@correo.com">
                    <div *ngIf="emailForm.get('email')?.invalid && emailForm.get('email')?.touched" class="text-danger mt-2">
                      Por favor ingresa un correo electrónico válido
                    </div>
                  </div>
                  <div class="d-flex justify-content-end">
                    <button type="button" class="btn btn-outline-secondary me-2" (click)="cancelEmailUpdate()">Cancelar</button>
                    <button type="submit" class="btn btn-primary" [disabled]="emailForm.invalid || emailSending">
                      <span *ngIf="!emailSending">Enviar</span>
                      <span *ngIf="emailSending"><i class="bi bi-hourglass me-1"></i> Enviando...</span>
                    </button>
                  </div>
                </form>
              </div>
              
              <!-- Mensaje de éxito -->
              <div class="alert alert-success d-flex align-items-center" *ngIf="emailSent">
                <i class="bi bi-check-circle me-2"></i>
                <div>
                  Solicitud enviada correctamente. Recibirás actualizaciones por email.
                </div>
              </div>
            </div>
          </div>
        </div>
        
        <!-- Historial de Trámite -->
        <div class="mt-4">
          <h5>Historial de Trámite</h5>
          <div class="ticket-details p-0" id="ticketTimeline">
            <!-- Mostramos cada evento del historial -->
            <ng-container *ngFor="let evento of reclamo.historial; let i = index">
              <div class="d-flex p-3" [ngClass]="{'border-bottom': i < reclamo.historial.length - 1}">
                <div class="me-3">
                  <div class="rounded-circle d-flex align-items-center justify-content-center" style="width: 36px; height: 36px;"
                      [ngClass]="{
                        'bg-primary text-white': evento.estado === ESTADO.REGISTRADO,
                        'bg-warning text-dark': evento.estado === ESTADO.EN_PROCESO,
                        'bg-info text-white': evento.estado === ESTADO.ATENDIDO,
                        'bg-success text-white': evento.estado === ESTADO.CERRADO,
                        'bg-danger text-white': evento.estado === ESTADO.RECHAZADO
                      }">
                    <i class="bi" 
                       [ngClass]="{
                         'bi-file-earmark-text': evento.estado === ESTADO.REGISTRADO,
                         'bi-gear': evento.estado === ESTADO.EN_PROCESO,
                         'bi-headset': evento.estado === ESTADO.ATENDIDO,
                         'bi-check-circle': evento.estado === ESTADO.CERRADO,
                         'bi-x-circle': evento.estado === ESTADO.RECHAZADO
                       }"></i>
                  </div>
                </div>
                <div>
                  <div class="d-flex justify-content-between">
                    <h6 class="fw-bold mb-1">
                      <ng-container *ngIf="evento.estado === ESTADO.REGISTRADO; else cambioEstado">
                        Registro del reclamo
                      </ng-container>
                      <ng-template #cambioEstado>
                        Cambio a "{{ evento.estadoTexto }}"
                      </ng-template>
                    </h6>
                    <span class="text-muted small">{{ evento.fecha | date:'dd/MM/yyyy' }}</span>
                  </div>
                  <p class="mb-0 text-muted">{{ evento.comentario }}</p>
                  <small class="text-muted">Por: {{ evento.usuarioNombre }}</small>
                </div>
              </div>
            </ng-container>
          </div>
        </div>
      </div>
    </div>
    
    <!-- Contact Information -->
    <div class="card">
      <div class="card-body p-4">
        <h5 class="mb-3"><i class="bi bi-question-circle me-2"></i>¿Necesitas ayuda adicional?</h5>
        <p>Si tienes alguna pregunta o necesitas actualizaciones sobre tu reclamo, contáctanos:</p>
        <div class="row">
          <div class="col-md-4 mb-3 mb-md-0">
            <div class="d-flex align-items-center">
              <div class="me-3 text-primary">
                <i class="bi bi-envelope" style="font-size: 1.5rem;"></i>
              </div>
              <div>
                <p class="m-0 text-muted small">Correo Electrónico</p>
                <p class="m-0 fw-bold">soporte&amp;#64;empresa.com</p>
              </div>
            </div>
          </div>
          <div class="col-md-4 mb-3 mb-md-0">
            <div class="d-flex align-items-center">
              <div class="me-3 text-primary">
                <i class="bi bi-telephone" style="font-size: 1.5rem;"></i>
              </div>
              <div>
                <p class="m-0 text-muted small">Teléfono</p>
                <p class="m-0 fw-bold">+1 (800) 123-4567</p>
              </div>
            </div>
          </div>
          <div class="col-md-4">
            <div class="d-flex align-items-center">
              <div class="me-3 text-primary">
                <i class="bi bi-chat" style="font-size: 1.5rem;"></i>
              </div>
              <div>
                <p class="m-0 text-muted small">Chat en Vivo</p>
                <p class="m-0 fw-bold">Lun-Vie: 9AM - 6PM</p>
              </div>
            </div>
          </div>
        </div>
      </div>
    </div>
    
    <!-- FAQ Section -->
    <div class="card mt-4">
      <div class="card-body p-4">
        <h5 class="mb-3"><i class="bi bi-info-circle me-2"></i>Preguntas Frecuentes</h5>
        
        <div class="accordion" id="faqAccordion">
          <div class="accordion-item border-0 mb-3 shadow-sm">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#faq1">
                ¿Cuánto tiempo tarda en resolverse mi reclamo?
              </button>
            </h2>
            <div id="faq1" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                El tiempo de resolución depende del tipo de reclamo. En general, nuestro tiempo promedio de resolución es de 3 a 5 días hábiles. Los reclamos que requieren revisión técnica pueden tomar hasta 7 días hábiles.
              </div>
            </div>
          </div>
          
          <div class="accordion-item border-0 mb-3 shadow-sm">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#faq2">
                ¿Cómo puedo solicitar una actualización de mi caso?
              </button>
            </h2>
            <div id="faq2" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                Puedes solicitar una actualización enviando un correo electrónico a soporte&amp;#64;empresa.com con tu número de ticket en el asunto, o utilizando el botón "Solicitar actualización por email" en la sección de acciones disponibles.
              </div>
            </div>
          </div>
          
          <div class="accordion-item border-0 mb-3 shadow-sm">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#faq3">
                ¿Qué significa el estado "Atendido"?
              </button>
            </h2>
            <div id="faq3" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                El estado "Atendido" significa que un representante ha revisado tu caso, ha determinado una solución y está en proceso de implementarla. En este punto, tu reclamo ha sido validado y pronto será resuelto.
              </div>
            </div>
          </div>
          
          <div class="accordion-item border-0 shadow-sm">
            <h2 class="accordion-header">
              <button class="accordion-button collapsed bg-light" type="button" data-bs-toggle="collapse" data-bs-target="#faq4">
                ¿Por qué mi reclamo podría ser rechazado?
              </button>
            </h2>
            <div id="faq4" class="accordion-collapse collapse" data-bs-parent="#faqAccordion">
              <div class="accordion-body">
                Un reclamo puede ser rechazado por varias razones, incluyendo: garantía expirada, uso indebido del producto, información incompleta o inconsistente, o si el reclamo no cumple con nuestras políticas de devolución y reembolso.
              </div>
            </div>
            </div>
         </div>
       </div>
     </div>
   </div>
 </div>